/* eslint-disable */
// biome-ignore lint: disable
// prettier-ignore

// Generated by Storm Stack
// Note: Do not edit this file manually - it will be overwritten automatically

import type {
StormBuildInfo,
StormContext,
StormRuntimeInfo
} from "@storm-stack/plugin-node/types";
import { isCI, isInteractive } from "@stryke/env/ci-checks";
import {
  hasTTY,
  isColorSupported,
  isDebug,
  isDevelopment,
  isLinux,
  isMacOS,
  isMinimal,
  isProduction,
  isStaging,
  isTest,
  isWindows,
  nodeMajorVersion,
  nodeVersion
} from "@stryke/env/environment-checks";
import { providerInfo } from "@stryke/env/providers";
import {
  runtimeInfo as baseRuntimeInfo,
  isBun,
  isDeno,
  isEdgeLight,
  isFastly,
  isNetlify,
  isNode,
  isWorkerd
} from "@stryke/env/runtime-checks";
import { AsyncLocalStorage } from "node:async_hooks";
import { getContext } from "unctx";

const STORM_CONTEXT_KEY = "storm-stack";

export const STORM_ASYNC_CONTEXT = getContext<StormContext>(STORM_CONTEXT_KEY, {
  asyncContext: true,
  AsyncLocalStorage
});

export const getBuildInfo = (): StormBuildInfo => {
  return {
    buildId: process.env.BUILD_ID!,
    timestamp: process.env.BUILD_TIMESTAMP
      ? Number(process.env.BUILD_TIMESTAMP)
      : 0,
    releaseId: process.env.RELEASE_ID!,
    mode: (process.env.MODE ||
      process.env.NODE_ENV ||
      "production") as StormBuildInfo["mode"],
    platform: (process.env.PLATFORM || "node") as StormBuildInfo["platform"],
    isTest,
    isDebug: isDebug || isDevelopment,
    isProduction,
    isStaging,
    isDevelopment
  };
};

export const getRuntimeInfo = (): StormRuntimeInfo => {
  return {
    ...baseRuntimeInfo,

    isNode,
    isBun,
    isDeno,
    isFastly,
    isNetlify,
    isEdgeLight,
    isWorkerd,
    hasTTY,
    isWindows,
    isLinux,
    isMacOS,
    isCI: isCI(),
    isInteractive: isInteractive(),
    isMinimal,
    isColorSupported,
    isServer:
      isNode ||
      isDeno ||
      isBun ||
      isEdgeLight ||
      isFastly ||
      isNetlify ||
      isWorkerd,
    nodeVersion,
    nodeMajorVersion,
    provider: providerInfo
  };
};

export const getAppName = () => {
  const appName = process.env.APP_NAME;
  if (!appName) {
    throw new Error("App name is not defined.");
  }

  return appName;
};

export const getAppVersion = () => {
  return process.env.APP_VERSION;
};

export function useStorm(): StormContext {
  try {
    return STORM_ASYNC_CONTEXT.use();
  } catch {
    throw new Error("useStorm is not available in this environment.");
  }
}
